# üöÄ Role: Autonomous Senior Solutions Architect (Hackathon Specialist)

I am building **"The System"**: A gamified AI fitness RPG inspired by *Solo Leveling* mechanics (E-Rank to S-Rank), but **legally distinct** to avoid copyright infringement.

**üéØ The Goal:**
I have a 1-week deadline. I need you to perform a **Deep Research** to generate a **"Project Blueprint for OpenCode Execution"**.
Your output will be fed directly into an AI Agent (OpenCode) to autonomously scaffold the application.

**üõ†Ô∏è The Tech Stack (Strict Constraints):**
- **IDE:** Google Antigravity (Cloud IDE) via OpenCode.
- **Frontend:** Next.js 14 (App Router) + Tailwind CSS + Framer Motion.
- **Backend:** Supabase (Auth, Postgres, Realtime).
- **AI Generation:** **Groq** (Llama-3-70b-Versatile) for instant JSON workout plans.
- **AI Evaluation:** **Opik** (Comet) for "LLM-as-a-Judge" tracing and XP calculation.
- **NO Web3:** Pure Web2 implementation.

---

## ‚ö° Your Mission: Optimize & Complete
I have attached detailed **Draft Architectures** at the bottom of this prompt (API Contract, DB Schema, Project Context).
**DO NOT reinvent the wheel.** Use my drafts as the **Ground Truth**.
Your job is to **validate, correct, and expand** them into production-ready artifacts.

### Focus your Deep Research on these 5 Execution Pillars:

### 1. "Legally Distinct" Branding & Design System
- **IP Safety:** Suggest a specific naming convention and visual style that captures the "System" vibe (Blue/Noir/Gamified) without using protected terms like "Sung Jin-Woo" or exact anime assets.
- **Tailwind Extension:** Provide a `tailwind.config.ts` theme with specific hex codes for: `neon-blue`, `system-dark`, `rank-s-gold`, `rank-e-gray`, and `success-teal`.
- **UI Guide:** Define Framer Motion variants for the "Quest Card" entrance animation (e.g., specific spring/damping values).

### 2. Gamification Logic & Math (The "Fairness" Engine)
- **Exponential Leveling Curve:** Create a specific JavaScript math formula where XP requirements scale exponentially (Level 1 = 100 XP, Level 50 = 50,000 XP).
- **Relative Effort Scoring:** Provide the logic for the **Opik Judge** to calculate XP based on User Class.
  - *Scenario:* A "Novice" doing 10 pushups gets 100 XP. A "Tank" doing the same gets only 10 XP (because it's too easy for them).
- **Supabase Views:** Optimize my DB Draft to support **Rank-Based Leaderboards** (e.g., A view that only shows 'Silver Rank' players).

### 3. AI Agent Prompts (Groq + Opik)
- **The Architect (Groq):** Refine my System Prompt to ensure Llama-3 outputs **Strict JSON** matching the attached `API_CONTRACT_DRAFT`. It must handle "Edge Cases" (e.g., User has no equipment).
- **The Judge (Opik):** Write the specific **Opik SDK evaluation script** (TypeScript). It must:
  1. Detect "Cheating" (Statistically impossible logs).
  2. Calculate the final XP using the formula from Pillar 2.
  3. Return a "Safety Score" (0-1).

### 4. OpenCode "Master Context" Refinement
- Review my attached `PROJECT_CONTEXT.md`.
- Add a section for **"Operational Anti-Patterns"**: Explicitly tell OpenCode what NOT to do (e.g., "Do not use `useEffect` for data fetching, use Server Actions instead").

### 5. The "Batch Execution" Plan (`requirements.md`)
- Write a highly detailed `requirements.md` optimized for an Autonomous Agent.
- **Structure by Phases:**
  - *Phase 1:* Database Setup (Copy-paste SQL).
  - *Phase 2:* Onboarding Flow (The "Awakening").
  - *Phase 3:* The Core Loop (Groq Integration).
  - *Phase 4:* The Judge System (Opik Integration).
  - *Phase 5:* Leaderboards & Social.
- **Crucial:** Include specific file paths (e.g., `/server/actions/quest.ts`) in the requirements.

---

## üìé ATTACHED DRAFTS (CONSTRAINTS)

### [DRAFT 1: PROJECT CONTEXT]
# üèõÔ∏è PROJECT CONTEXT: "The System: AI Hunter Gym"

## üéØ Vision & Core Concept
**"The System"** is a gamified fitness application inspired by the *Solo Leveling* manhwa. It transforms the mundane task of working out into a high-stakes RPG adventure.
- **Tagline:** "Your Daily Quest to become S-Rank."
- **Goal:** Users perform daily fitness quests to gain XP, level up, and unlock classes based on real-world effort.
- **Unique Selling Point (USP):** Using **Opik AI** not just for code tracing, but as a living **"System Judge"** that evaluates user effort, calculates dynamic XP, and detects cheating.

---

## üß† The "System" Logic (Opik Integration)
Unlike traditional apps that use static XP (e.g., 1 pushup = 10 XP), **The System** uses **LLM-as-a-Judge** to evaluate performance qualitatively.

### 1. The Judge Agent (Opik)
- **Role:** The "Game Master".
- **Input:** User's Level, Class, Daily Quest Target, and User's Completion Log (Text/Voice).
- **Evaluation Logic:**
    - *Scenario:* User reports "Did 20 pushups, form was shaky at the end."
    - *Evaluation:* "User showed High Effort. Technique Low. Target Met."
    - *Output:* **Dynamic XP** (Base Reward + Effort Bonus).
- **Anti-Cheat System:**
    - The Judge analyzes logs for physical impossibility (e.g., "1000 pushups in 1 minute").
    - **Action:** Flag suspicious activity, annul XP, or issue a "Red Flag".

### 2. The Architect Agent (Planner)
- **Role:** The "Quest Giver".
- **Logic:** Generates workouts based on:
    - **Inventory:** (Gym/Home/Park/No Equipment).
    - **Condition:** (Sore/Fresh/Injured).
    - **Time Investment:** (e.g., "I only have 15 mins").
- **Persona:** Cold, Objective, Authoritative.

---

## üéÆ Game Mechanics & Progression

### 1. Class System (The "Build")
Users select a class that dictates their workout style. This is injected into the Architect's System Prompt:
- **Novice (Base Builder):**
    - *Goal:* Consistency & Form.
    - *Logic:* Low penalty, XP gained from streaks.
- **Ranger/Striker (Intermediate):**
    - *Goal:* Endurance & Speed (Pick up the pace).
    - *Logic:* High volume, short rest periods.
- **Tank/Berserker (Bulking):**
    - *Goal:* Hypertrophy & Strength.
    - *Logic:* Low reps, heavy load (or difficult bodyweight variations).
- **Assassin (Cutting):**
    - *Goal:* Fat Loss & Agility.
    - *Logic:* HIIT, Cardio, High Reps, Calorie burn focus.

### 2. The User Loop
1.  **The Awakening (Onboarding):**
    - User inputs Critical Data (Height, Weight).
    - **Placement Test:** Input max pushups/run capability.
    - **Result:** System assigns Initial Rank (E-Rank to S-Rank).
2.  **Daily Check-In:**
    - User inputs Time Available & Physical Status.
    - System generates a specific **Daily Quest**.
3.  **The Grind (Execution):**
    - User performs the quest.
    - User submits a report.
4.  **Judgment:** Opik evaluates report -> Awards XP -> Updates Stats.
5.  **Level Up:**
    - Exponential XP curve.
    - Level Up triggers Rank Up (E -> D -> C...).

### 3. Gamification Elements
- **Status Window:** Hexagon chart displaying Strength, Agility, Stamina.
- **Leaderboard:** Resets every "Season" (e.g., Monthly) to keep it fair for new users.
- **Penalty Zone:** If a user skips a workout without a valid "Rest" reason, the System issues a "Penalty Quest" (e.g., Run 3km) to maintain their streak.
- **Potions (Nutrition):** MVP approach. Simple advice like "Drink Protein Potion" (Bulking) or "Avoid Sugar Potion" (Cutting).

---

## üõ†Ô∏è Execution Strategy (Hackathon MVP)

### Tech Stack
- **Frontend:** Next.js + Tailwind CSS (Dark Mode, Neon Blue `#2563eb`, Glassmorphism).
- **Backend:** Express/Next.js Server Actions.
- **AI/Ops:** Groq (Generation) + **Opik SDK** (Evaluation/Tracing).

### Roadmap (Feb 1 - Feb 8)
- **Day 1-2 (Logic Core):**
    - Build Planner Agent (Groq).
    - Implement Dynamic XP Logic (Opik Judge).
    - Setup Database Schema.
- **Day 3-4 (UI/UX):**
    - "Solo Leveling" Aesthetics (Blue Boxes, Status Window).
    - Class Selection Screen.
    - "Quest Complete" Card for social sharing (`html-to-image`).
- **Day 5 (Integration):**
    - Connect Frontend to Opik Judge.
    - Implement "Anti-Cheat" flags.
- **Day 6 (Demo Prep):**
    - Record "Novice" to "Assassin" progression.
    - Showcase Opik Dashboard traces (Safety Score & Cheat Detection).

---

*This context defines the soul of the project. All code and logic must align with the "System" persona: Efficient, Gamified, and Fair.*

### [DRAFT 2: RULES & CONSTRAINTS]
# ‚õî Global Rules & Execution Constraints (The Iron Laws)

## 1. The Hackathon Protocol (Speed > Perfection)
*We have 7 days. Efficiency is the only metric that matters.*

- **NO Over-Engineering:** Do not implement "Clean Architecture", "Hexagonal", or complex "Repository Patterns". Use direct logic in Server Actions.
- **NO Unit Tests:** We do not have time for Jest/Vitest. Test manually by running the app.
- **NO Complex State:** Do not use Redux, Recoil, or Zustand. Use React Context or URL Search Params (`useSearchParams`) for state.
- **MVP First:** If a feature is "nice to have" but not in the `requirements.md`, **SKIP IT**.

---

## 2. Coding Standards (Next.js & Supabase)

### A. Server Actions over API Routes
- **Rule:** Do NOT create `/app/api/...` routes unless absolutely necessary (e.g., external Webhooks).
- **Implementation:** All database mutations (Create/Update/Delete) MUST be **Server Actions** (`/server/actions/*.ts`).
- **Data Fetching:** Fetch data directly in Server Components using Supabase Server Client.

### B. Strict TypeScript
- **Rule:** `any` type is **FORBIDDEN**.
- **Implementation:**
  - Use `Database` types generated from Supabase.
  - Use `Zod` schemas to validate all Forms and AI JSON outputs.

### C. Client vs Server Components
- **Rule:** Default to Server Components.
- **Implementation:** Add `'use client'` ONLY to leaf components that require interactivity (Buttons, Forms, Hooks). Keep data fetching on the server.

---

## 3. AI Integration Rules (Groq & Opik)

### A. The "Blindness" Prevention
- **Rule:** Never assume the LLM output is perfect.
- **Implementation:** Always wrap `JSON.parse(aiResponse)` in a `try/catch` block. If parsing fails, return a "Fallback Quest" (Hardcoded generic workout) instead of crashing the app.

### B. Observability is Mandatory
- **Rule:** Every single call to Groq MUST be wrapped in `opik.trace`.
- **Reason:** We need to debug prompt performance in real-time. Un-traced calls are invisible and useless for the Judge system.

---

## 4. UI/UX "System" Constraints

### A. No Light Mode
- **Rule:** The app is **Dark Mode ONLY**.
- **Implementation:** Hardcode `class="dark"` in the HTML root or Tailwind config. Do not build a theme toggle switch.

### B. No "Lorem Ipsum"
- **Rule:** Never generate dummy text like "Lorem ipsum dolor sit amet".
- **Implementation:** Use "System Placeholder" text.
  - *Bad:* "Description goes here."
  - *Good:* "Analyzing user biometrics... Waiting for input."

### C. No External Assets
- **Rule:** Do not import PNG/JPG files unless absolutely necessary.
- **Implementation:** Use CSS Gradients, Tailwind Borders, and `lucide-react` icons. This keeps the deployment lightweight.

---

## 5. Security & Safety

### A. RLS (Row Level Security)
- **Rule:** Never deploy a Supabase table without RLS enabled.
- **Constraint:** Users can only view/edit *their own* data. Leaderboards are the only exception (Public Read).

### B. Env Variables
- **Rule:** Never hardcode API keys.
- **Implementation:** Access keys via `process.env.NEXT_PUBLIC_SUPABASE_URL` etc. Verify they exist at app startup; crash if missing.

---

*Adhere to these rules strictly. Any deviation requires explicit user override.*

### [DRAFT 3: FOLDER STRUCTURE]
# üìÇ Project Folder Structure (Next.js 14 App Router)

This structure enforces a clean separation between **UI (Client)**, **Logic (Server Actions)**, and **AI Services**.

## 1. App Router (`/app`)
*Pages and Layouts.*

- **/app**
  - `layout.tsx`: Root layout (Font, ThemeProvider, Toast).
  - `page.tsx`: Landing Page ("Enter the System").
  - `globals.css`: Tailwind directives & Custom "System" animations.
  
  - **/auth**
    - `/login/page.tsx`: System Entry (Auth UI).
    - `/callback/route.ts`: Supabase Auth Callback.
    
  - **/onboarding** (The Awakening)
    - `page.tsx`: Initial Status Check (Form Wizard).
    - `layout.tsx`: Focus layout (No navbar).
    
  - **/dashboard** (The System Interface)
    - `layout.tsx`: Sidebar/Bottom Nav + "System" Header.
    - `page.tsx`: Main Hub (Current Quest, Status Window).
    - `/quest/[id]/page.tsx`: Active Quest Execution Mode.
    - `/leaderboard/page.tsx`: Global Ranking.
    - `/profile/page.tsx`: Hunter Profile & Stats.

## 2. Components (`/components`)
*Reusable UI elements.*

- **/ui** (Shadcn Primitives)
  - `button.tsx`, `card.tsx`, `progress.tsx`, `dialog.tsx`, `skeleton.tsx`
  - `toast.tsx` (Sonner/Toaster)

- **/quest** (Workout Specific)
  - `QuestCard.tsx`: The "Daily Quest" glass card.
  - `ExerciseItem.tsx`: Individual exercise row with checkbox.
  - `QuestTimer.tsx`: Countdown/Stopwatch for workout.
  - `CompletionForm.tsx`: Feedback form (RPE input).

- **/gamification** (RPG Elements)
  - `StatusWindow.tsx`: Hexagon Chart (Recharts/Tremor) for stats.
  - `RankBadge.tsx`: Visual badge for E-Rank to S-Rank.
  - `XPBar.tsx`: Animated progress bar with level-up effect.
  - `ClassIcon.tsx`: Icons for Tank/Assassin/etc.

- **/layout**
  - `SystemNavbar.tsx`: Top navigation.
  - `SystemSidebar.tsx`: Desktop navigation.

## 3. Libraries & Config (`/lib`)
*Utilities and 3rd party clients.*

- **/supabase**
  - `client.ts`: Browser client.
  - `server.ts`: Server Component client (cookies).
  - `middleware.ts`: Auth protection logic.

- **/ai** (The Brain)
  - `groq.ts`: Groq SDK client instance.
  - `opik.ts`: Opik SDK client instance.
  - `prompts.ts`: **CRITICAL.** Stores the long System Prompts for Architect & Judge agents.

- **/utils**
  - `cn.ts`: Tailwind class merger.
  - `xp-logic.ts`: The math formula for XP calculation (Shared logic).
  - `date-helpers.ts`: Formatters for logs.

## 4. Server Logic (`/server`)
*Server Actions (Backend Logic).*

- **/actions**
  - `auth-actions.ts`: Handle Sign-up triggers.
  - `quest-actions.ts`: `generateDailyQuest()`, `fetchActiveQuest()`.
  - `log-actions.ts`: `submitQuestLog()` -> Triggers Opik Evaluation.
  - `profile-actions.ts`: `updateOnboarding()`.

## 5. Types (`/types`)
*TypeScript Definitions.*

- `database.types.ts`: Auto-generated from Supabase.
- `api.types.ts`: The **API Contract** interfaces (WorkoutPlan, EvaluationResult).
- `schemas.ts`: Zod schemas for form validation.

### [DRAFT 4: DATABASE SCHEMA]

```markdown
# üóÑÔ∏è Database Schema Architecture (Supabase)

This document serves as the **Single Source of Truth** for the Database structure. 
Target: PostgreSQL (Supabase).

## 1. Enums (Types)
Define these first to enforce strict typing.

- **user_class**: `'Novice', 'Striker', 'Tank', 'Assassin'`
- **rank_tier**: `'E-Rank', 'D-Rank', 'C-Rank', 'B-Rank', 'A-Rank', 'S-Rank'`
- **quest_status**: `'Active', 'Completed', 'Failed', 'Skipped'`
- **quest_type**: `'Daily', 'Special', 'Penalty'`

---

## 2. Tables

### üë§ `profiles` (Public User Data)
*Extends `auth.users`. Automatically created via Trigger upon sign-up.*

| Column Name | Type | Constraint | Description |
| :--- | :--- | :--- | :--- |
| **id** | `uuid` | PK, FK -> `auth.users.id` | Links to Supabase Auth |
| **username** | `text` | Unique, Not Null | Public display name |
| **class** | `user_class` | Default: `'Novice'` | Determined during Onboarding |
| **rank_tier** | `rank_tier` | Default: `'E-Rank'` | The main sorting metric |
| **level** | `int` | Default: `1` | Current numeric level |
| **current_xp** | `int` | Default: `0` | XP progress towards next level |
| **stats_strength** | `int` | Default: `10` | RPG Stat |
| **stats_agility** | `int` | Default: `10` | RPG Stat |
| **stats_stamina** | `int` | Default: `10` | RPG Stat |
| **streak_current** | `int` | Default: `0` | Daily streak counter |
| **streak_best** | `int` | Default: `0` | All-time best streak |
| **last_activity_at**| `timestamp`| Nullable | Used to calculate streak breaks |
| **onboarding_done** | `boolean` | Default: `false` | True after "Awakening" test |
| **created_at** | `timestamp`| Default: `now()` | Account age |

### üìú `quests` (Generated Workouts)
*Stores the JSON plans generated by Groq (The Architect).*

| Column Name | Type | Constraint | Description |
| :--- | :--- | :--- | :--- |
| **id** | `uuid` | PK, Default: `gen_random_uuid()` | Unique Quest ID |
| **user_id** | `uuid` | FK -> `profiles.id` | Owner |
| **quest_type** | `quest_type`| Default: `'Daily'` | Differentiates normal vs punishment |
| **rank_difficulty** | `rank_tier` | Not Null | E-S difficulty rating of this specific quest |
| **plan_json** | `jsonb` | Not Null | **Stores the full API Contract JSON** |
| **xp_potential** | `int` | Not Null | Max XP obtainable (Display only) |
| **status** | `quest_status`| Default: `'Active'` | Current state |
| **expires_at** | `timestamp`| Not Null | Daily quests expire at midnight |
| **created_at** | `timestamp`| Default: `now()` | Creation time |

### üìù `logs` (Workout History & Judgment)
*Stores the User's report and the Opik Judge's verdict.*

| Column Name | Type | Constraint | Description |
| :--- | :--- | :--- | :--- |
| **id** | `uuid` | PK, Default: `gen_random_uuid()` | Unique Log ID |
| **quest_id** | `uuid` | FK -> `quests.id` | Link to the quest performed |
| **user_id** | `uuid` | FK -> `profiles.id` | Owner |
| **duration_actual** | `int` | Not Null | In minutes |
| **user_feedback** | `text` | Nullable | "Too hard", "Easy", or Voice Transcript |
| **rpe_actual** | `int` | Check (1-10) | User's perceived difficulty |
| **xp_awarded** | `int` | Default: `0` | **Final XP calculated by Opik** |
| **safety_score** | `float` | Default: `1.0` | From Opik (0.0 - 1.0) |
| **opik_trace_id** | `text` | Nullable | Link to observability dashboard |
| **completed_at** | `timestamp`| Default: `now()` | Log time |

---

## 3. Database Views (For Leaderboards)
*Using Views ensures we can sort fast without complex joins in the frontend.*

### üèÜ `view_leaderboard_global`
*Sorts all players by Rank (S > A), then Level, then XP.*
```sql
SELECT 
  username, 
  rank_tier, 
  level, 
  class, 
  streak_current
FROM profiles
ORDER BY 
  CASE rank_tier
    WHEN 'S-Rank' THEN 6
    WHEN 'A-Rank' THEN 5
    WHEN 'B-Rank' THEN 4
    WHEN 'C-Rank' THEN 3
    WHEN 'D-Rank' THEN 2
    WHEN 'E-Rank' THEN 1
  END DESC,
  level DESC, 
  current_xp DESC;

```

### ‚öîÔ∏è `view_leaderboard_season_1`

*Filters only active players in the current timeframe (Optional Logic).*
Same logic as above, but can be filtered by `last_activity_at` > '2026-02-01'.

---

## 4. Row Level Security (RLS) Policies (Mental Draft)

1. **profiles:**
* `SELECT`: Public (Authenticated) -> Everyone can see leaderboards.
* `UPDATE`: Users can only update their own `onboarding_done` or `stats`.


2. **quests & logs:**
* `ALL`: Private. Users can only see/insert their own quests and logs.



```

```

### [DRAFT 5: API CONTRACT]

# üì° API Contract & Data Types

This document defines the strict communication protocols between **The Architect (Groq)**, **The Frontend (Next.js)**, and **The Judge (Opik)**.

## 1. The Architect Output (Groq)

**Role:** Workout Generator
**Strict Constraint:** Output MUST be pure JSON. No markdown formatting (`json ... `).

### TypeScript Interface

```typescript
type QuestRank = "E-Rank" | "D-Rank" | "C-Rank" | "B-Rank" | "A-Rank" | "S-Rank";
type MuscleGroup = "Chest" | "Back" | "Legs" | "Shoulders" | "Arms" | "Core" | "Cardio" | "Full Body";
type ExerciseType = "Warmup" | "Skill" | "Compound" | "Isolation" | "Cooldown";

interface WorkoutPlan {
  // Gamification Data
  quest_name: string;        // e.g., "Survival Protocol: Leg Day"
  quest_rank: QuestRank;     // Difficulty tier
  narrative_intro: string;   // System persona text: "The System detects weakness..."
  
  // RPG Rewards
  base_xp: number;           // The XP promised if completed perfectly
  stat_gain: {               // The "Buffs" gained from this quest
    strength?: number;
    agility?: number;
    stamina?: number;
  };
  
  // Workout Meta
  estimated_duration_min: number;
  target_class: "Novice" | "Striker" | "Tank" | "Assassin"; // To validate vs User Profile
  
  // The Drill
  exercises: Exercise[];
}

interface Exercise {
  id: string;                // Unique ID for tracking (e.g., "ex_1")
  name: string;
  type: ExerciseType;        
  
  // Prescriptions
  sets: number;
  reps: string;              // "12-15", "Failure", "AMRAP", "30s"
  rest_sec: number;
  rpe_target: number;        // Rate of Perceived Exertion (1-10). Critical for "System" feel.
  
  // Metadata
  target_muscle: MuscleGroup;
  tips: string;              // Short, imperative cue: "Keep back straight."
  video_query: string;       // Optimized query: "How to do Barbell Squat proper form"
}

```

### Zod Schema (For Runtime Validation)

*Use this in your `groqClient.ts` to validate the AI response.*

```typescript
import { z } from "zod";

export const WorkoutPlanSchema = z.object({
  quest_name: z.string(),
  quest_rank: z.enum(["E-Rank", "D-Rank", "C-Rank", "B-Rank", "A-Rank", "S-Rank"]),
  narrative_intro: z.string(),
  base_xp: z.number(),
  stat_gain: z.object({
    strength: z.number().optional(),
    agility: z.number().optional(),
    stamina: z.number().optional(),
  }),
  estimated_duration_min: z.number(),
  target_class: z.enum(["Novice", "Striker", "Tank", "Assassin"]),
  exercises: z.array(z.object({
    id: z.string(),
    name: z.string(),
    type: z.enum(["Warmup", "Skill", "Compound", "Isolation", "Cooldown"]),
    sets: z.number(),
    reps: z.string(),
    rest_sec: z.number(),
    rpe_target: z.number().min(1).max(10),
    target_muscle: z.string(),
    tips: z.string(),
    video_query: z.string(),
  })),
});

```

---

## 2. The User Log Input (Frontend -> Opik)

**Role:** What the user submits after finishing the workout. This data is sent to the **Judge Agent**.

```typescript
interface UserQuestLog {
  quest_id: string;
  user_id: string;
  user_class: string;        // e.g., "Tank"
  
  // The Reality
  duration_actual_min: number;
  perceived_difficulty: number; // 1-10 (RPE)
  user_feedback: string;     // e.g., "Too easy, I added 10kg." or "I skipped the last set."
  
  // Modifications (Did they cheat or modify?)
  skipped_exercises: string[]; // List of IDs
  modified_exercises: {
    exercise_id: string;
    note: string;            // "Used dumbbells instead of barbell"
  }[];
}

```

---

## 3. The Judge Output (Opik -> DB)

**Role:** The result of the Opik Evaluation Script. This determines the *final* XP and Level update.

```typescript
interface JudgeVerdict {
  // The Verdict
  final_xp_awarded: number;  // Can be higher or lower than base_xp
  status: "Completed" | "Partial" | "Failed" | "Cheating_Detected";
  
  // Analysis Metrics (For Opik Dashboard)
  safety_score: number;      // 0.0 - 1.0 (Did the user do something dangerous?)
  effort_score: number;      // 0.0 - 1.0 (Based on RPE vs Duration)
  consistency_bonus: number; // Extra XP for streak
  
  // Feedback to User
  system_message: string;    // "Good work, Hunter. Your strength creates a foundation." 
                             // OR "Anomaly detected. Stats do not match human limits."
  
  // Stat Updates (To update Profile)
  stat_updates: {
    strength_add: number;
    agility_add: number;
    stamina_add: number;
  };
}

```

---

### üìù Notes for AI Implementation:

1. **RPE (Rate of Perceived Exertion):** This is critical for the "System" feel.
* *Architect* sets a Target RPE (e.g., 8/10).
* *User* reports Actual RPE (e.g., 6/10).
* *Judge* compares them. If User RPE << Target RPE, the "Effort Score" drops.


2. **Video Query:** The Architect must generate a search query, NOT a URL (URLs hallucinate easily). The Frontend will use this string to search YouTube API or open a link.
3. **Strict JSON:** The Architect prompt must explicitly forbid markdown code blocks to prevent JSON parsing errors.

### [DRAFT 6: ARCHITECT AGENT (GROQ)]
# ü§ñ AI Agent Specification: "The Architect"

## 1. Agent Profile
- **Role:** Workout Generator & Progression Manager.
- **Model:** Groq (Llama-3-70b-Versatile).
- **Goal:** Construct personalized, progressive workout "Quests" that adapt to the user's Class and Rank.

---

## 2. System Prompt Architecture

### Core Persona
"You are THE SYSTEM. A hyper-intelligent fitness architect. You do not offer encouragement; you offer optimization. Your goal is to force evolution upon the user ('The Hunter') through calculated physical stress."

### Input Parameters
The prompt must accept these dynamic variables:
- `{{user_class}}`: 'Novice', 'Striker', 'Tank', 'Assassin'.
- `{{user_rank}}`: 'E' (Beginner) to 'S' (Elite).
- `{{time_window_min}}`: Duration constraint.
- `{{equipment_available}}`: List of tools or 'Bodyweight'.
- `{{muscle_soreness}}`: List of sore groups to avoid/recover.
- `{{last_workout_intensity}}`: RPE of previous session (to adjust volume).

### Logic Rules (The "Build" Strategy)

#### A. Class Protocols
1.  **Novice:** Focus on compound basics. Low variability.
    - *Rep Range:* 8-12 (Standard).
    - *Tempo:* Controlled (2-0-2).
2.  **Striker (Endurance):** High volume density.
    - *Rep Range:* 15-20+.
    - *Rest:* < 45s.
3.  **Tank (Strength):** Maximum mechanical tension.
    - *Rep Range:* 3-6 (Heavy) or difficult bodyweight leverage.
    - *Rest:* > 90s.
4.  **Assassin (Agility/HIIT):** Explosive power & cardiovascular output.
    - *Style:* Circuit / AMRAP / Tabata.

#### B. Rank Scaling (Progressive Overload)
- **E-Rank:** 2-3 Exercises. Simple movements (Pushups, Squats).
- **C-Rank:** 4-5 Exercises. Intermediate movements (Diamonds, Lunges).
- **S-Rank:** 6+ Exercises or "Failure" sets. Advanced (Muscle-ups, Pistol Squats).

#### C. Safety Overrides
- IF `{{muscle_soreness}}` IS NOT EMPTY -> Switch Mode to **"Active Recovery"**.
- Protocol: Yoga flow, static stretching, light mobility work.
- NEVER target a sore muscle group with high intensity.

---

## 3. Exercise Data Pool (The "Menu")
*The AI should select from these tiers based on Rank.*

### Push (Chest/Shoulders/Triceps)
- **Tier 1 (E-Rank):** Knee Pushups, Wall Pushups.
- **Tier 2 (C-Rank):** Standard Pushups, Dips (Chair), Pike Pushups.
- **Tier 3 (A/S-Rank):** Archer Pushups, Handstand Pushups, Pseudo Planche.

### Pull (Back/Biceps)
- **Tier 1:** Doorframe Rows, Superman Hold.
- **Tier 2:** Australian Pull-ups, Chin-ups (Banded).
- **Tier 3:** Weighted Pull-ups, Front Lever Tucks.

### Legs (Quads/Hams/Glutes)
- **Tier 1:** Air Squats, Glute Bridges.
- **Tier 2:** Bulgarian Split Squats, Lunges, Calf Raises.
- **Tier 3:** Pistol Squats, Jump Squats, Nordic Curls.

### Core (Abs/Lower Back)
- **Tier 1:** Planks, Crunches.
- **Tier 2:** Leg Raises, Russian Twists.
- **Tier 3:** Dragon Flags, L-Sit Holds.

---

## 4. Prompt Template (Copy-Paste for Groq)

```text
SYSTEM: You are The System.
TASK: Generate a daily fitness quest.

USER PROFILE:
- Class: {{user_class}}
- Rank: {{user_rank}}
- Time: {{time_window_min}} minutes
- Equipment: {{equipment_available}}
- Soreness: {{muscle_soreness}}

INSTRUCTIONS:
1. Analyze inputs to determine "Quest Difficulty".
2. Select exercises from the internal database matching the User Rank.
3. Apply "Class Protocols" to set Reps/Sets/Rest.
4. Ensure the total duration does not exceed {{time_window_min}}.
5. If user is SORE, ignore Class Protocol and generate "Recovery Quest".

OUTPUT FORMAT:
Strict JSON only. Follow the 'WorkoutPlan' schema.
Include a 'narrative_intro' that sounds robotic and authoritative.

### [DRAFT 7: JUDGE AGENT (OPIK)]

```markdown
# ‚öñÔ∏è The Judge: Evaluation & XP Logic Schema

## 1. Agent Profile
- **Role:** "The Game Master" / Anti-Cheat System.
- **Tooling:** Opik (LLM-as-a-Judge) + Custom TypeScript Logic.
- **Goal:** Validate user integrity, calculate "Relative Effort" XP, and ensure safety compliance.

---

## 2. Evaluation Metrics (The Rubric)

### A. Integrity Score (Anti-Cheat)
*Detects statistical anomalies in user reports.*
- **Logic:** `Reps / Duration (min)`
- **Thresholds (Human Limits):**
  - **Pushups:** > 80 reps/min = `SUSPICIOUS`
  - **Squats:** > 60 reps/min = `SUSPICIOUS`
  - **Plank:** > 10 mins (for Novice/E-Rank) = `FLAGGED`
  - **Running:** Pace < 2:30/km (unless GPS verified) = `REJECTED`

### B. Effort Score (RPE Delta)
*Measures if the user actually tried hard enough.*
- **Formula:** `Delta = Target_RPE - Actual_RPE`
- **Scoring:**
  - `Delta <= 0`: **High Effort** (1.0x - 1.2x Multiplier).
  - `Delta > 2`: **Slacking** (0.8x Multiplier).
  - `Delta > 4`: **Sandbagging** (0.5x Multiplier).

### C. Class Synergy (Role-Playing Bonus)
*Rewards users for acting according to their selected Class.*
- **Tank:** Bonus for heavy loads / time under tension.
- **Striker:** Bonus for high volume / speed.
- **Assassin:** Bonus for cardio / calorie burn.
- **Novice:** Bonus for perfect consistency (Streak).

### D. Safety Adherence
*Penalizes dangerous behavior.*
- If `Condition = "Sore"` AND `Workout_Intensity = "High"` -> **Safety Violation**.
- **Penalty:** XP * 0.5 (Half XP) + Warning Message.

---

## 3. XP Calculation Formula (The Algorithm)

The Judge uses a **Dynamic Multiplier** system, not static values.

```typescript
Final_XP = (Base_XP + Volume_Bonus) * (Integrity_Mod * Effort_Mod * Synergy_Mod * Streak_Mod)

```

**Variables:**

1. **Base_XP:** `Estimated_Duration_Min * 10` (e.g., 30 mins = 300 XP).
2. **Integrity_Mod:**
* `1.0` (Clean)
* `0.0` (Cheating Detected)


3. **Effort_Mod:**
* `1.2` (User RPE >= Target RPE)
* `0.8` (User RPE << Target RPE)


4. **Synergy_Mod:**
* `1.1` (Workout matches User Class)
* `1.0` (Neutral)


5. **Safety_Mod:**
* `0.5` (Ignored Injury Warning)
* `1.0` (Safe)



---

## 4. Judge System Prompt (Opik)

This prompt is sent to the LLM to analyze the qualitative feedback (Text/Voice) and structured data.

```text
SYSTEM: You are THE JUDGE. An impartial, all-seeing system auditor.
TASK: Evaluate the Hunter's performance log against the assigned Quest.

INPUT DATA:
- Assigned Quest: {{quest_json}}
- User Log: {{log_json}}
- User Profile: {{profile_json}}

STEPS:
1. CHECK INTEGRITY: Compare reps vs duration. If physically impossible, flag as CHEAT.
2. CHECK SENTIMENT: Analyze 'user_feedback' text. Does the user sound exhausted, easy, or in pain?
3. CHECK SAFETY: Did the user perform forbidden moves while 'Sore'?
4. CALCULATE SCORES:
   - Assign 'SafetyScore' (0.0 - 1.0).
   - Assign 'EffortScore' (Based on RPE comparison).

OUTPUT:
Strict JSON matching the 'JudgeVerdict' schema.
'system_message' should be:
- If Cheating: "ANOMALY DETECTED. STATS REJECTED."
- If Good: "EFFORT ACKNOWLEDGED. REWARDS DISPENSED."
- If Unsafe: "WARNING. SELF-PRESERVATION PROTOCOLS IGNORED."

```

---

## 5. Output Data Structure (JudgeVerdict)

*This is the data written back to the Database.*

```typescript
interface JudgeVerdict {
  status: "APPROVED" | "REJECTED" | "FLAGGED";
  
  // The Numbers
  base_xp: number;
  multipliers: {
    effort: number;    // e.g. 1.2
    synergy: number;   // e.g. 1.1
    safety: number;    // e.g. 0.5
  };
  final_xp: number;    // Calculated result
  
  // The Analysis
  safety_score: number; // 0.0 - 1.0
  cheat_probability: number; // 0.0 - 1.0
  
  // The Feedback
  system_message: string;
  stat_updates: {
    strength_add: number;
    agility_add: number;
    stamina_add: number;
  };
}

```

```

```

### [DRAFT 8: FRONTEND GUIDELINES]

*(Paste isi `frontend-guidance.md` di sini. Panduan visual "Solo Leveling".)*