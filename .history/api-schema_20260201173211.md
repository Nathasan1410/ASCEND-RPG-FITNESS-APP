# üì° API Contract & Data Types

This document defines the strict communication protocols between **The Architect (Groq)**, **The Frontend (Next.js)**, and **The Judge (Opik)**.

## 1. The Architect Output (Groq)

**Role:** Workout Generator
**Strict Constraint:** Output MUST be pure JSON. No markdown formatting (`json ... `).

### TypeScript Interface

```typescript
type QuestRank = "E-Rank" | "D-Rank" | "C-Rank" | "B-Rank" | "A-Rank" | "S-Rank";
type MuscleGroup = "Chest" | "Back" | "Legs" | "Shoulders" | "Arms" | "Core" | "Cardio" | "Full Body";
type ExerciseType = "Warmup" | "Skill" | "Compound" | "Isolation" | "Cooldown";

interface WorkoutPlan {
  // Gamification Data
  quest_name: string;        // e.g., "Survival Protocol: Leg Day"
  quest_rank: QuestRank;     // Difficulty tier
  narrative_intro: string;   // System persona text: "The System detects weakness..."
  
  // RPG Rewards
  base_xp: number;           // The XP promised if completed perfectly
  stat_gain: {               // The "Buffs" gained from this quest
    strength?: number;
    agility?: number;
    stamina?: number;
  };
  
  // Workout Meta
  estimated_duration_min: number;
  target_class: "Novice" | "Striker" | "Tank" | "Assassin"; // To validate vs User Profile
  
  // The Drill
  exercises: Exercise[];
}

interface Exercise {
  id: string;                // Unique ID for tracking (e.g., "ex_1")
  name: string;
  type: ExerciseType;        
  
  // Prescriptions
  sets: number;
  reps: string;              // "12-15", "Failure", "AMRAP", "30s"
  rest_sec: number;
  rpe_target: number;        // Rate of Perceived Exertion (1-10). Critical for "System" feel.
  
  // Metadata
  target_muscle: MuscleGroup;
  tips: string;              // Short, imperative cue: "Keep back straight."
  video_query: string;       // Optimized query: "How to do Barbell Squat proper form"
}

```

### Zod Schema (For Runtime Validation)

*Use this in your `groqClient.ts` to validate the AI response.*

```typescript
import { z } from "zod";

export const WorkoutPlanSchema = z.object({
  quest_name: z.string(),
  quest_rank: z.enum(["E-Rank", "D-Rank", "C-Rank", "B-Rank", "A-Rank", "S-Rank"]),
  narrative_intro: z.string(),
  base_xp: z.number(),
  stat_gain: z.object({
    strength: z.number().optional(),
    agility: z.number().optional(),
    stamina: z.number().optional(),
  }),
  estimated_duration_min: z.number(),
  target_class: z.enum(["Novice", "Striker", "Tank", "Assassin"]),
  exercises: z.array(z.object({
    id: z.string(),
    name: z.string(),
    type: z.enum(["Warmup", "Skill", "Compound", "Isolation", "Cooldown"]),
    sets: z.number(),
    reps: z.string(),
    rest_sec: z.number(),
    rpe_target: z.number().min(1).max(10),
    target_muscle: z.string(),
    tips: z.string(),
    video_query: z.string(),
  })),
});

```

---

## 2. The User Log Input (Frontend -> Opik)

**Role:** What the user submits after finishing the workout. This data is sent to the **Judge Agent**.

```typescript
interface UserQuestLog {
  quest_id: string;
  user_id: string;
  user_class: string;        // e.g., "Tank"
  
  // The Reality
  duration_actual_min: number;
  perceived_difficulty: number; // 1-10 (RPE)
  user_feedback: string;     // e.g., "Too easy, I added 10kg." or "I skipped the last set."
  
  // Modifications (Did they cheat or modify?)
  skipped_exercises: string[]; // List of IDs
  modified_exercises: {
    exercise_id: string;
    note: string;            // "Used dumbbells instead of barbell"
  }[];
}

```

---

## 3. The Judge Output (Opik -> DB)

**Role:** The result of the Opik Evaluation Script. This determines the *final* XP and Level update.

```typescript
interface JudgeVerdict {
  // The Verdict
  final_xp_awarded: number;  // Can be higher or lower than base_xp
  status: "Completed" | "Partial" | "Failed" | "Cheating_Detected";
  
  // Analysis Metrics (For Opik Dashboard)
  safety_score: number;      // 0.0 - 1.0 (Did the user do something dangerous?)
  effort_score: number;      // 0.0 - 1.0 (Based on RPE vs Duration)
  consistency_bonus: number; // Extra XP for streak
  
  // Feedback to User
  system_message: string;    // "Good work, Hunter. Your strength creates a foundation." 
                             // OR "Anomaly detected. Stats do not match human limits."
  
  // Stat Updates (To update Profile)
  stat_updates: {
    strength_add: number;
    agility_add: number;
    stamina_add: number;
  };
}

```

---

### üìù Notes for AI Implementation:

1. **RPE (Rate of Perceived Exertion):** This is critical for the "System" feel.
* *Architect* sets a Target RPE (e.g., 8/10).
* *User* reports Actual RPE (e.g., 6/10).
* *Judge* compares them. If User RPE << Target RPE, the "Effort Score" drops.


2. **Video Query:** The Architect must generate a search query, NOT a URL (URLs hallucinate easily). The Frontend will use this string to search YouTube API or open a link.
3. **Strict JSON:** The Architect prompt must explicitly forbid markdown code blocks to prevent JSON parsing errors.